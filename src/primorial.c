#include <stdio.h>
#include <e-hal.h>

typedef struct inout_data
{
  long long p;
  long long res;
} data_t;

#define _BufSize   (4096)
#define _BufOffset (0x01000000)

data_t buf[256] = {
{4294974991ll,0ll},
{4294974997ll,0ll},
{4294975031ll,0ll},
{4294975037ll,0ll},
{4294975043ll,0ll},
{4294975051ll,0ll},
{4294975057ll,0ll},
{4294975079ll,0ll},
{4294975093ll,0ll},
{4294975109ll,0ll},
{4294975117ll,0ll},
{4294975123ll,0ll},
{4294975147ll,0ll},
{4294975163ll,0ll},
{4294975211ll,0ll},
{4294975229ll,0ll},
{4294975297ll,0ll},
{4294975339ll,0ll},
{4294975369ll,0ll},
{4294975393ll,0ll},
{4294975397ll,0ll},
{4294975411ll,0ll},
{4294975417ll,0ll},
{4294975453ll,0ll},
{4294975463ll,0ll},
{4294975471ll,0ll},
{4294975499ll,0ll},
{4294975537ll,0ll},
{4294975543ll,0ll},
{4294975547ll,0ll},
{4294975561ll,0ll},
{4294975589ll,0ll},
{4294975627ll,0ll},
{4294975649ll,0ll},
{4294975673ll,0ll},
{4294975697ll,0ll},
{4294975717ll,0ll},
{4294975733ll,0ll},
{4294975739ll,0ll},
{4294975747ll,0ll},
{4294975753ll,0ll},
{4294975757ll,0ll},
{4294975781ll,0ll},
{4294975793ll,0ll},
{4294975843ll,0ll},
{4294975847ll,0ll},
{4294975849ll,0ll},
{4294975877ll,0ll},
{4294975889ll,0ll},
{4294975891ll,0ll},
{4294975907ll,0ll},
{4294975939ll,0ll},
{4294975987ll,0ll},
{4294976051ll,0ll},
{4294976069ll,0ll},
{4294976071ll,0ll},
{4294976083ll,0ll},
{4294976089ll,0ll},
{4294976129ll,0ll},
{4294976131ll,0ll},
{4294976149ll,0ll},
{4294976219ll,0ll},
{4294976221ll,0ll},
{4294976261ll,0ll},
{4294976263ll,0ll},
{4294976269ll,0ll},
{4294976281ll,0ll},
{4294976293ll,0ll},
{4294976311ll,0ll},
{4294976321ll,0ll},
{4294976341ll,0ll},
{4294976347ll,0ll},
{4294976359ll,0ll},
{4294976381ll,0ll},
{4294976383ll,0ll},
{4294976417ll,0ll},
{4294976431ll,0ll},
{4294976447ll,0ll},
{4294976453ll,0ll},
{4294976501ll,0ll},
{4294976519ll,0ll},
{4294976537ll,0ll},
{4294976549ll,0ll},
{4294976579ll,0ll},
{4294976617ll,0ll},
{4294976627ll,0ll},
{4294976639ll,0ll},
{4294976677ll,0ll},
{4294976717ll,0ll},
{4294976723ll,0ll},
{4294976731ll,0ll},
{4294976743ll,0ll},
{4294976773ll,0ll},
{4294976797ll,0ll},
{4294976839ll,0ll},
{4294976857ll,0ll},
{4294976867ll,0ll},
{4294976887ll,0ll},
{4294976929ll,0ll},
{4294976941ll,0ll},
{4294976957ll,0ll},
{4294976977ll,0ll},
{4294976981ll,0ll},
{4294977023ll,0ll},
{4294977047ll,0ll},
{4294977067ll,0ll},
{4294977079ll,0ll},
{4294977083ll,0ll},
{4294977091ll,0ll},
{4294977097ll,0ll},
{4294977149ll,0ll},
{4294977161ll,0ll},
{4294977163ll,0ll},
{4294977173ll,0ll},
{4294977217ll,0ll},
{4294977233ll,0ll},
{4294977259ll,0ll},
{4294977287ll,0ll},
{4294977311ll,0ll},
{4294977317ll,0ll},
{4294977329ll,0ll},
{4294977347ll,0ll},
{4294977389ll,0ll},
{4294977391ll,0ll},
{4294977413ll,0ll},
{4294977419ll,0ll},
{4294977431ll,0ll},
{4294977433ll,0ll},
{4294977481ll,0ll},
{4294977499ll,0ll},
{4294977503ll,0ll},
{4294977523ll,0ll},
{4294977559ll,0ll},
{4294977571ll,0ll},
{4294977623ll,0ll},
{4294977667ll,0ll},
{4294977671ll,0ll},
{4294977751ll,0ll},
{4294977761ll,0ll},
{4294977763ll,0ll},
{4294977769ll,0ll},
{4294977787ll,0ll},
{4294977793ll,0ll},
{4294977823ll,0ll},
{4294977839ll,0ll},
{4294977847ll,0ll},
{4294977859ll,0ll},
{4294977881ll,0ll},
{4294977893ll,0ll},
{4294977899ll,0ll},
{4294977943ll,0ll},
{4294977961ll,0ll},
{4294977989ll,0ll},
{4294977991ll,0ll},
{4294978003ll,0ll},
{4294978021ll,0ll},
{4294978027ll,0ll},
{4294978033ll,0ll},
{4294978057ll,0ll},
{4294978067ll,0ll},
{4294978081ll,0ll},
{4294978087ll,0ll},
{4294978091ll,0ll},
{4294978123ll,0ll},
{4294978133ll,0ll},
{4294978147ll,0ll},
{4294978157ll,0ll},
{4294978169ll,0ll},
{4294978201ll,0ll},
{4294978211ll,0ll},
{4294978223ll,0ll},
{4294978231ll,0ll},
{4294978249ll,0ll},
{4294978283ll,0ll},
{4294978307ll,0ll},
{4294978309ll,0ll},
{4294978313ll,0ll},
{4294978327ll,0ll},
{4294978333ll,0ll},
{4294978361ll,0ll},
{4294978381ll,0ll},
{4294978399ll,0ll},
{4294978489ll,0ll},
{4294978511ll,0ll},
{4294978517ll,0ll},
{4294978553ll,0ll},
{4294978559ll,0ll},
{4294978591ll,0ll},
{4294978627ll,0ll},
{4294978661ll,0ll},
{4294978679ll,0ll},
{4294978729ll,0ll},
{4294978733ll,0ll},
{4294978757ll,0ll},
{4294978777ll,0ll},
{4294978781ll,0ll},
{4294978799ll,0ll},
{4294978811ll,0ll},
{4294978867ll,0ll},
{4294978873ll,0ll},
{4294978949ll,0ll},
{4294978973ll,0ll},
{4294979009ll,0ll},
{4294979023ll,0ll},
{4294979033ll,0ll},
{4294979047ll,0ll},
{4294979053ll,0ll},
{4294979069ll,0ll},
{4294979077ll,0ll},
{4294979081ll,0ll},
{4294979111ll,0ll},
{4294979153ll,0ll},
{4294979159ll,0ll},
{4294979167ll,0ll},
{4294979207ll,0ll},
{4294979233ll,0ll},
{4294979237ll,0ll},
{4294979287ll,0ll},
{4294979321ll,0ll},
{4294979329ll,0ll},
{4294979383ll,0ll},
{4294979407ll,0ll},
{4294979417ll,0ll},
{4294979443ll,0ll},
{4294979461ll,0ll},
{4294979471ll,0ll},
{4294979519ll,0ll},
{4294979527ll,0ll},
{4294979531ll,0ll},
{4294979567ll,0ll},
{4294979587ll,0ll},
{4294979617ll,0ll},
{4294979627ll,0ll},
{4294979653ll,0ll},
{4294979693ll,0ll},
{4294979719ll,0ll},
{4294979737ll,0ll},
{4294979771ll,0ll},
{4294979809ll,0ll},
{4294979831ll,0ll},
{4294979851ll,0ll},
{4294979861ll,0ll},
{4294979863ll,0ll},
{4294979881ll,0ll},
{4294979891ll,0ll},
{4294979917ll,0ll},
{4294979929ll,0ll},
{4294979933ll,0ll},
{4294979939ll,0ll},
{4294979947ll,0ll},
{4294979987ll,0ll},
{4294979999ll,0ll},
{4294980007ll,0ll},
{4294980071ll,0ll},
{4294980089ll,0ll},
{4294980121ll,0ll}
};

int main(int argc, char*argv[])
{
  unsigned row, col, coreid;
  e_platform_t platform;
  e_epiphany_t dev;
  e_mem_t emem;
  
  e_init(NULL);
  e_reset_system();
  e_get_platform_info(&platform);

  // Allocate a buffer in shared external memory
  // for message passing from eCore to host.
  e_alloc(&emem, _BufOffset, _BufSize);

  // Open a workgroup
  e_open(&dev, 0, 0, platform.rows, platform.cols);

  // Load the device program onto all the eCores
  e_load_group("e_primorial.srec", &dev, 0, 0, platform.rows, platform.cols, E_FALSE);

  e_write(&emem, 0, 0, 0x0, buf, sizeof(buf));
  e_start(&dev, 0, 0);
  while (1)
  {
    unsigned status;
    e_read(&dev, 0, 0, E_REG_STATUS, &status, sizeof(status));
    if ((status & 1) == 0)
      break;
  }
  e_read(&emem, 0, 0, 0x0, buf, sizeof(buf));

  for (int i = 0; i < 32; ++i)
    printf("%lld %lld\n", buf[i].p, buf[i].res);
  
  e_close(&dev);
  e_free(&emem);
  e_finalize();

  return 0;
}
